apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-seed-scripts
data:
  seed.sql: |
    -- =====================================================
    -- DONNÉES FICTIVES POUR PLATEFORME ÉLECTRONIQUE
    -- =====================================================

    -- =========================
    -- BASE: user_auth_db
    -- =========================
    \c user_auth_db;

    CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        username VARCHAR(100) UNIQUE NOT NULL,
        email VARCHAR(255) UNIQUE NOT NULL,
        password_hash VARCHAR(255) NOT NULL,
        first_name VARCHAR(100),
        last_name VARCHAR(100),
        phone VARCHAR(20),
        role VARCHAR(50) DEFAULT 'USER',
        enabled BOOLEAN DEFAULT true,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    INSERT INTO users (username, email, password_hash, first_name, last_name, phone, role) VALUES
    ('admin', 'admin@plateforme.tn', '$2a$10$N9qo8uLOickgx2ZMRZoHK.ZzQYXvVqUdB4JKlDQKLYPF1ZhNxYpWe', 'Admin', 'System', '+216 71 000 001', 'ADMIN'),
    ('yesmine.grassa', 'yasmine.grassa@isetkr.tn', '$2a$10$N9qo8uLOickgx2ZMRZoHK.ZzQYXvVqUdB4JKlDQKLYPF1ZhNxYpWe', 'Yesmine', 'Grassa', '+216 73 000 002', 'ADMIN'),
    ('Moez.Hachem', 'moez.hachem@oceantunisie.tn', '$2a$10$N9qo8uLOickgx2ZMRZoHK.ZzQYXvVqUdB4JKlDQKLYPF1ZhNxYpWe', 'Moez', 'Hachem', '+216 73 000 222', 'ADMIN'),
    ('ahmed.benali', 'ahmed.benali@email.tn', '$2a$10$N9qo8uLOickgx2ZMRZoHK.ZzQYXvVqUdB4JKlDQKLYPF1ZhNxYpWe', 'Ahmed', 'Ben Ali', '+216 98 111 111', 'USER'),
    ('fatma.trabelsi', 'fatma.trabelsi@email.tn', '$2a$10$N9qo8uLOickgx2ZMRZoHK.ZzQYXvVqUdB4JKlDQKLYPF1ZhNxYpWe', 'Fatma', 'Trabelsi', '+216 97 222 222', 'USER'),
    ('mohamed.souissi', 'mohamed.souissi@email.tn', '$2a$10$N9qo8uLOickgx2ZMRZoHK.ZzQYXvVqUdB4JKlDQKLYPF1ZhNxYpWe', 'Mohamed', 'Souissi', '+216 96 333 333', 'USER'),
    ('Islem.Manaii', 'islem.manai@email.tn', '$2a$10$N9qo8uLOickgx2ZMRZoHK.ZzQYXvVqUdB4JKlDQKLYPF1ZhNxYpWe', 'Islem', 'Manai', '+216 95 444 444', 'USER'),
    ('youssef.hamdi', 'youssef.hamdi@email.tn', '$2a$10$N9qo8uLOickgx2ZMRZoHK.ZzQYXvVqUdB4JKlDQKLYPF1ZhNxYpWe', 'Youssef', 'Hamdi', '+216 94 555 555', 'MERCHANT'),
    ('salma.karray', 'salma.karray@email.tn', '$2a$10$N9qo8uLOickgx2ZMRZoHK.ZzQYXvVqUdB4JKlDQKLYPF1ZhNxYpWe', 'Salma', 'Karray', '+216 93 666 666', 'MERCHANT');

    -- =========================
    -- BASE: subscription_db
    -- =========================
    \c subscription_db;

    CREATE TABLE IF NOT EXISTS plans (
        id SERIAL PRIMARY KEY,
        name VARCHAR(100) NOT NULL,
        description TEXT,
        price DECIMAL(10,3) NOT NULL,
        currency VARCHAR(3) DEFAULT 'TND',
        duration_months INTEGER NOT NULL,
        max_transactions INTEGER,
        features JSONB,
        active BOOLEAN DEFAULT true,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS subscriptions (
        id SERIAL PRIMARY KEY,
        user_id INTEGER NOT NULL,
        plan_id INTEGER REFERENCES plans(id),
        status VARCHAR(50) DEFAULT 'ACTIVE',
        start_date DATE NOT NULL,
        end_date DATE NOT NULL,
        auto_renew BOOLEAN DEFAULT true,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    INSERT INTO plans (name, description, price, duration_months, max_transactions, features) VALUES
    ('Gratuit', 'Plan de base gratuit', 0.000, 12, 10, '{"support": "email", "api_access": false}'),
    ('Starter', 'Pour les petites entreprises', 29.900, 1, 100, '{"support": "email", "api_access": true, "reports": "basic"}'),
    ('Professional', 'Pour les entreprises en croissance', 99.900, 1, 500, '{"support": "priority", "api_access": true, "reports": "advanced", "multi_user": true}'),
    ('Enterprise', 'Solution complète pour grandes entreprises', 299.900, 1, -1, '{"support": "24/7", "api_access": true, "reports": "custom", "multi_user": true, "dedicated_manager": true}');

    INSERT INTO subscriptions (user_id, plan_id, status, start_date, end_date) VALUES
    (3, 1, 'ACTIVE', '2026-01-01', '2027-01-01'),
    (4, 2, 'ACTIVE', '2026-01-15', '2026-02-15'),
    (5, 3, 'ACTIVE', '2026-01-10', '2026-02-10'),
    (6, 2, 'ACTIVE', '2026-01-20', '2026-02-20'),
    (7, 4, 'ACTIVE', '2026-01-05', '2026-02-05'),
    (8, 3, 'ACTIVE', '2026-01-12', '2026-02-12');

    -- =========================
    -- BASE: invoice_db
    -- =========================
    \c invoice_db;

    CREATE TABLE IF NOT EXISTS invoices (
        id SERIAL PRIMARY KEY,
        invoice_number VARCHAR(50) UNIQUE NOT NULL,
        user_id INTEGER NOT NULL,
        customer_name VARCHAR(200),
        customer_email VARCHAR(255),
        customer_address TEXT,
        subtotal DECIMAL(10,3) NOT NULL,
        tax_rate DECIMAL(5,2) DEFAULT 19.00,
        tax_amount DECIMAL(10,3),
        total DECIMAL(10,3) NOT NULL,
        status VARCHAR(50) DEFAULT 'DRAFT',
        issue_date DATE,
        due_date DATE,
        paid_date DATE,
        notes TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS invoice_items (
        id SERIAL PRIMARY KEY,
        invoice_id INTEGER REFERENCES invoices(id) ON DELETE CASCADE,
        description VARCHAR(500) NOT NULL,
        quantity INTEGER NOT NULL,
        unit_price DECIMAL(10,3) NOT NULL,
        total DECIMAL(10,3) NOT NULL
    );

    INSERT INTO invoices (invoice_number, user_id, customer_name, customer_email, customer_address, subtotal, tax_amount, total, status, issue_date, due_date) VALUES
    ('INV-2026-0001', 7, 'Société ABC', 'contact@abc.tn', '15 Rue de la Liberté, Tunis', 1500.000, 285.000, 1785.000, 'PAID', '2026-01-05', '2026-02-05'),
    ('INV-2026-0002', 7, 'Enterprise XYZ', 'info@xyz.tn', '22 Avenue Bourguiba, Sousse', 3200.000, 608.000, 3808.000, 'SENT', '2026-01-10', '2026-02-10'),
    ('INV-2026-0003', 8, 'Startup Tech', 'hello@startup.tn', '8 Rue du Lac, Tunis', 750.000, 142.500, 892.500, 'PAID', '2026-01-12', '2026-02-12'),
    ('INV-2026-0004', 7, 'Commerce Plus', 'commerce@plus.tn', '45 Avenue Farhat Hached, Sfax', 2100.000, 399.000, 2499.000, 'DRAFT', '2026-01-20', '2026-02-20'),
    ('INV-2026-0005', 8, 'Digital Services', 'contact@digital.tn', '12 Rue Ibn Khaldoun, Monastir', 4500.000, 855.000, 5355.000, 'SENT', '2026-01-22', '2026-02-22');

    INSERT INTO invoice_items (invoice_id, description, quantity, unit_price, total) VALUES
    (1, 'Service de consultation', 10, 100.000, 1000.000),
    (1, 'Formation équipe', 1, 500.000, 500.000),
    (2, 'Développement application web', 1, 2500.000, 2500.000),
    (2, 'Maintenance mensuelle', 2, 350.000, 700.000),
    (3, 'Design graphique', 5, 150.000, 750.000),
    (4, 'Intégration API', 3, 700.000, 2100.000),
    (5, 'Solution e-commerce complète', 1, 4500.000, 4500.000);

    -- =========================
    -- BASE: payment_db
    -- =========================
    \c payment_db;

    CREATE TABLE IF NOT EXISTS payments (
        id SERIAL PRIMARY KEY,
        payment_reference VARCHAR(100) UNIQUE NOT NULL,
        user_id INTEGER NOT NULL,
        invoice_id INTEGER,
        amount DECIMAL(10,3) NOT NULL,
        currency VARCHAR(3) DEFAULT 'TND',
        payment_method VARCHAR(50) NOT NULL,
        status VARCHAR(50) DEFAULT 'PENDING',
        transaction_id VARCHAR(255),
        payment_date TIMESTAMP,
        metadata JSONB,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS payment_methods (
        id SERIAL PRIMARY KEY,
        user_id INTEGER NOT NULL,
        type VARCHAR(50) NOT NULL,
        provider VARCHAR(100),
        last_four VARCHAR(4),
        expiry_date VARCHAR(7),
        is_default BOOLEAN DEFAULT false,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    INSERT INTO payments (payment_reference, user_id, invoice_id, amount, payment_method, status, transaction_id, payment_date) VALUES
    ('PAY-2026-00001', 3, 1, 1785.000, 'CARD', 'COMPLETED', 'TXN_ABC123456', '2026-01-06 10:30:00'),
    ('PAY-2026-00002', 4, 3, 892.500, 'CARD', 'COMPLETED', 'TXN_DEF789012', '2026-01-13 14:45:00'),
    ('PAY-2026-00003', 5, NULL, 99.900, 'CARD', 'COMPLETED', 'TXN_GHI345678', '2026-01-10 09:15:00'),
    ('PAY-2026-00004', 6, NULL, 29.900, 'FLOUCI', 'COMPLETED', 'FLC_JKL901234', '2026-01-20 16:20:00'),
    ('PAY-2026-00005', 7, NULL, 299.900, 'BANK_TRANSFER', 'PENDING', NULL, NULL),
    ('PAY-2026-00006', 8, NULL, 99.900, 'CARD', 'COMPLETED', 'TXN_MNO567890', '2026-01-12 11:00:00');

    INSERT INTO payment_methods (user_id, type, provider, last_four, expiry_date, is_default) VALUES
    (3, 'CARD', 'Visa', '4532', '12/2028', true),
    (4, 'CARD', 'Mastercard', '8741', '06/2027', true),
    (5, 'CARD', 'Visa', '1234', '03/2029', true),
    (6, 'FLOUCI', 'Flouci', NULL, NULL, true),
    (7, 'CARD', 'Visa', '9876', '09/2028', true),
    (7, 'BANK_TRANSFER', 'BIAT', NULL, NULL, false),
    (8, 'CARD', 'Mastercard', '5555', '11/2027', true);

    -- =========================
    -- BASE: notification_db
    -- =========================
    \c notification_db;

    CREATE TABLE IF NOT EXISTS notifications (
        id SERIAL PRIMARY KEY,
        user_id INTEGER NOT NULL,
        type VARCHAR(50) NOT NULL,
        title VARCHAR(255) NOT NULL,
        message TEXT,
        status VARCHAR(50) DEFAULT 'PENDING',
        sent_at TIMESTAMP,
        read_at TIMESTAMP,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    INSERT INTO notifications (user_id, type, title, message, status, sent_at) VALUES
    (3, 'PAYMENT', 'Paiement reçu', 'Votre paiement de 1785.000 TND a été confirmé.', 'SENT', '2026-01-06 10:35:00'),
    (4, 'PAYMENT', 'Paiement reçu', 'Votre paiement de 892.500 TND a été confirmé.', 'SENT', '2026-01-13 14:50:00'),
    (7, 'INVOICE', 'Nouvelle facture', 'Une nouvelle facture INV-2026-0002 a été créée.', 'SENT', '2026-01-10 09:00:00');

    -- =========================
    -- Vérification finale
    -- =========================
    \c user_auth_db
    SELECT 'user_auth_db: ' || COUNT(*) || ' users' FROM users;
    \c subscription_db
    SELECT 'subscription_db: ' || COUNT(*) || ' plans, ' || (SELECT COUNT(*) FROM subscriptions) || ' subscriptions' FROM plans;
    \c invoice_db
    SELECT 'invoice_db: ' || COUNT(*) || ' invoices' FROM invoices;
    \c payment_db
    SELECT 'payment_db: ' || COUNT(*) || ' payments' FROM payments;
    \c notification_db
    SELECT 'notification_db: ' || COUNT(*) || ' notifications' FROM notifications;
